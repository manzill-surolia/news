<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jaipur News</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: auto;
      padding: 1rem;
    }
    h1 { margin-bottom: 1rem; }
    ul { list-style-type: none; padding: 0; }
    li { padding: 0.4rem 0; border-bottom: 1px solid #ddd; }
    .src { color: #555; font-size: 0.9rem; }
    #error   { color: crimson; font-weight: bold; }
    #loading {
      color: #555; font-size: 1.1rem; text-align: center; margin-top: 1rem;
      animation: blink 1.2s linear infinite alternate;
    }
    @keyframes blink { 0% {opacity: .3;} 100% {opacity: 1;} }
  </style>
</head>
<body>
  <h1>Jaipur News</h1>
  <p id="loading">Loading headlines…</p>
  <ul id="news" hidden></ul>
  <p id="error" hidden></p>

<script>
/* -------------------------------------------------------------
   CONFIGURATION
------------------------------------------------------------- */
const RSS_URL    = 'https://news.google.com/rss/search?q=%E0%A4%9C%E0%A4%AF%E0%A4%AA%E0%A5%81%E0%A4%B0&hl=hi&gl=IN&ceid=IN:hi';
// Ordered list of free, no‑auth CORS proxies (stop at first that works)
const PROXIES = [
  'https://api.allorigins.win/raw?url=',
  'https://thingproxy.freeboard.io/fetch/',
  'https://cors.isomorphic-git.org/',
];
const LIMIT      = 40;   // max headlines
const LOADER_MIN_MS = 500; // minimum loader visible time in ms

/* -------------------------------------------------------------
   UTILITY HELPERS
------------------------------------------------------------- */
function show(el){el.hidden=false;} function hide(el){el.hidden=true;}
function escapeRegex(s){return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');}

async function fetchWithFallback(url){
  for(const p of PROXIES){
    try{
      const res = await fetch(p + encodeURIComponent(url));
      if(res.ok){return res.text();}
    }catch(_){}
  }
  // final attempt: try direct fetch (may fail CORS but worth a shot)
  const res = await fetch(url);
  if(res.ok) return res.text();
  throw new Error('All proxies failed');
}

/* -------------------------------------------------------------
   MAIN
------------------------------------------------------------- */
(async()=>{
  const start = Date.now();
  try{
    const xml = await fetchWithFallback(RSS_URL);
    const doc   = new DOMParser().parseFromString(xml, 'text/xml');
    const items = Array.from(doc.querySelectorAll('item')).slice(0, LIMIT);
    if(!items.length) throw new Error('no items');

    const ul = document.getElementById('news');

    items.forEach(item=>{
      let titleText=item.querySelector('title').textContent.trim();
      let sourceText='';
      const sourceEl=item.querySelector('source');
      if(sourceEl){sourceText=sourceEl.textContent.trim();}
      if(!sourceText){
        const parts=titleText.split(' - ');
        if(parts.length>1){sourceText=parts.pop(); titleText=parts.join(' - ');} }
      if(sourceText){
        const regex=new RegExp('\\s*[-–—]\\s*'+escapeRegex(sourceText)+'$','i');
        titleText=titleText.replace(regex,'').trim(); }

      const li=document.createElement('li');
      li.textContent=titleText+' ';
      if(sourceText){const span=document.createElement('span'); span.className='src'; span.textContent='('+sourceText+')'; li.appendChild(span);} ul.appendChild(li);
    });

    const elapsed=Date.now()-start; setTimeout(()=>{hide(document.getElementById('loading'));show(ul);},Math.max(0,LOADER_MIN_MS-elapsed));
  }catch(err){
    console.error(err);
    const p=document.getElementById('error');
    p.textContent='Unable to load news ('+err.message+')';
    hide(document.getElementById('loading')); show(p);
  }
})();
</script>
</body>
</html>
